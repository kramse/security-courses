\documentclass[Screen16to9,17pt]{foils}
\usepackage{zencurity-slides}

\externaldocument{prosa-secure-network-2025-exercises}
\selectlanguage{english}

% Netværk bruges overalt, men til mange forskellige formål. Med
% udgangspunkt i CIA modellen, Confidentiality, Integrity og Availability
% vil vi kigge netværkskomponenterne efter. Det skulle gerne resultere i
% anbefalinger til hvad der er vigtigt at sikre på gængse enheder som
% switche, routere og firewalls, men også hvordan en generel
% infrastruktur med servere, storage m.v. kan opbygges "robust" og bedre
% sikret mod hackere, misbrug og uheld.

\begin{document}

\mytitlepage
{What is a Secure Network}
{PROSA August \the\year{}}


\hlkprofiluk


\slide{Code of Conduct }

I subscribe to having a Code of Conduct for events, we need them still! Usually I say the BornHack code of conduct apply whenever I teach! \url{https://bornhack.dk/conduct/}

Today we talk about networking, so I recommend this also:
RIPE Code of Conduct
Publication date: 05 Oct 2021

\begin{quote}
Rationale
Our goals in having this Code of Conduct are:
\begin{list2}
\item {\bf To help everyone feel safe and included.} Many people will be new to our community. Some may have had negative experiences in other communities. We want to set a clear expectation that harassment and related behaviours are not tolerated here. If people do have an unpleasant experience, they will know that this is neither the norm nor acceptable to us as a community.

\item {\bf To make everyone aware of expected behaviour.} We are a diverse community; a CoC sets clear expectations in terms of how people should behave.
\end{list2}
\end{quote}
Source: {\small
\link{https://www.ripe.net/publications/docs/ripe-766}}

\slide{Time schedule}

\begin{list2}
\item 17:00 - 17:40 Introduction and basics for the subject

\item 17:40 - 18:05 Exercise in groups: example secure network

\item 30min break Eat with your family if you like, I will be around most of the break, available for questions

\item 18:45 - 19:30 Further teaching and exercises in the subject for the evening

\item 15min break Stretch your legs, get some more water

\item 19:45 - 20:30
Further teaching and exercises in the subject for the evening, Opal router, questions and more

\item 20:30 - 21:00 May contain exercises to be done on your own, with input from me
\end{list2}

\centerline{I will try to keep this plan for all evenings! So you hopefully can plan family life better}

Will also try to make smaller breaks/exercises during the slidesshows, check for questions etc.




\slide{About Equipment and Exercises}

\begin{list2}
\item Bringing a laptop is not required, but welcome.
\item Exercises booklets are available for many of my courses, see Github\\
but it is expected that participants will do any exercises on their own later or at the scheduled hacker days
\item The hacker days will be announced in various places

\item Events like BornHack are excellent places to arrange hacker days in the network warrior village, or other places
\item I announce mine at \link{https://nwwc.dk}
\end{list2}

\vskip 1cm

\centerline{\LARGE Invite a few friends, make a hacker day and work together!}



\slide{Hvad er et sikkert netværk? (Onlinemodul 1 af 3)}

%\hlkimage{}{}

\begin{quote}
Systemsikkerhed, forensics, hændelseshåndtering og softwaresikkerhed samt netværkssikkerhed med et holistisk blik
Første af tre online-aftenkurser om værktøjer, der får netværk og drift til at spille sammen for at give et løft til IT-sikkerheden i din organisation. Med udgangspunkt i netværkssikkerhed gennemgår vi, hvordan du kan være med til at sikre din organisation gennem design, arkitektur, værktøjer, processer og tiltag indenfor netværkslagene. Der vil være elementer af systemsikkerhed, forensics og hændelseshåndtering og softwaresikkerhed men hovedvægten er på netværkssikkerhed med et holistisk blik.
\vskip 5mm
Keywords: CIA modellen, CVE sårbarheder, switch, router, firewall, ACL, DoS/DDoS, VLAN, segmentering, logning, monitoring, Netflow, Zeek, Suricata, Nmap, Elasticsearch, IEEE 802.1x, IPv4, IPv6, NTP, DNS
\end{quote}

\begin{list2}
\item Man kan godt nøjes med en aften
\item Materialet er open source, I kan hente det hele -- og spørg gerne på email eller chat
\item Sidste tal fra Lulu var 86 tilmeldte -- hvilket gør interaktion lidt udfordrende -- async hvor I skriver spørgsmål i chatten virker typisk godt
\end{list2}


\slide{Goals for today}

%\hlkimage{6cm}{bornhack-camp-2024.jpg}

\begin{list2}
\item What is a secure network
\item Confidentiality, Integrity og Availability (CIA) model
\item Look at network security with a \emph{holistic approach}
\item Move down and up in the network layers
\item Discuss design, architecture and technical capabilities
\item Show tools that can help along the way

\end{list2}

Exercises
\begin{list2}
\item Larger exercise in groups: example secure network
\item Router exercise near end: Opal router inspiration
\end{list2}



\slide{Networks are trouble}

\hlkimage{9cm}{dragon-drawing-6.jpg}
\centerline{\Large Internet here be dragons}

\begin{list2}
\item Networks are constantly evolving
\item Threats are constantly increasing
\item Vulnerabilities are found daily
\item Even more vulnerabilities are \emph{developed} and \emph{installed}\\
Sorry developers, but some of you don't care, and it shows!
\end{list2}


\slide{Internet is based on Open Standards and collaboration!}

\begin{quote}
We reject kings, presidents, and voting.\\
We believe in rough consensus and running code.\\
-- The IETF credo Dave Clark, 1992.
\end{quote}

\begin{list2}
\item Request for comments - RFC -- series of documents describing internet standards
\item RFC, BCP, FYI, informational\\
First ones from 1969
\item Never changed but status changed to Obsoleted when a never version or document superseeds it\\
(Errata exist and are published though)
\item Standards track:\\
Proposed Standard $\rightarrow$ Draft Standard $\rightarrow$ Standard
\item  Open standards gurantee transparency, but not security
\end{list2}



\slide{What is a Secure Network}

%\hlkimage{}{}

\begin{quote}
A controlled environment with a purpose and goal which is designed, implemented and monitored to be sufficiently secure -- according to the policies and wishes of the owner and operator
\end{quote}

Example networks
\begin{list2}
\item Home network -- should support a \emph{family typically}
\item Factory network -- should support machines, robots, production of things
\item Office network -- should be available for employees and without malware and data leaks
\end{list2}

\slide{Network Security as a Holistic Approach}

%\hlkimage{10cm}{holistic-approach.png }
\begin{quote}
{\bf\Large holistic} adjective

\begin{list2}
\item[1]: of or relating to holism
\item[2] : relating to or concerned with wholes or with complete systems rather than with the analysis of, treatment of, or dissection into parts\\
holistic medicine attempts to treat both the mind and the body\\
holistic ecology views humans and the environment as a single system
\end{list2}
\end{quote}
Source: \url{https://www.merriam-webster.com/dictionary/holistic}

\begin{list2}
\item The network spans the whole organisation and we use \emph{the network} -- the Internet for many things
\item Network security affects the whole organisation
\item When improving network security, we often improve overall security
\end{list2}


\slide{Networks are Built from Components}

\hlkimage{15cm}{eugen-str-CrhsIRY3JWY-unsplash.jpg}

\hfill Photo by Eugen Str on Unsplash


\slide{The basic tools for countering threats}

{\Large Knowledge and insight}
\begin{list2}
\item Networks have end-points and conversations on multiple layers
\item Wireshark is advanced, try right-clicking different places
\item Name resolution includes low level MAC addresses, and IP - names
\end{list2}

\begin{list2}
\item Tcpdump format, built-in to many network devices
\item Remote packet dumps, like \verb+tcpdump –i eth0 –w packets.pcap+
\item Story: tcpdump was originally written in 1988 by Van Jacobson, Sally Floyd, Vern Paxson and Steven McCanne who were, at the time, working in the Lawrence Berkeley Laboratory Network Research Group\\
 \link{https://en.wikipedia.org/wiki/Tcpdump}
\end{list2}

\vskip 5mm

\centerline{\Large Great network security comes from knowing networks!}

\slide{Course Materials}

\begin{list2}
\item This material is in multiple parts:
\item Kickstart document -- basic information
\verb+kickstart-prosa-secure-network.pdf+
\item Slide show - the presentation - this file
\verb+prosa-secure-network-2025.pdf+
\item Exercise for today: example secure network \verb+exercise-secure-network-example.pdf+
\item Exercise/inspiration for today: \verb+kickstart-2-opal-router.pdf+
\item Exercise booklet -- large PDF with many exercises, stuff to do if you want to learn networks on your own
\verb+prosa-secure-network-2025-exercises.pdf+
\item Additional resources from the internet like \verb+firewall-book-10-DRAFT-PROSA.pdf+
%\item Later, next times:
%\verb+prosa-network-traffic-inspection-2025.pdf+
%\verb+prosa-network-monitoring-SIEM-2025.pdf+

\end{list2}


\slide{Book: Practical Packet Analysis (PPA3)}
\hlkimage{6cm}{PracticalPacketAnalysis3E_cover.png}

\emph{Practical Packet Analysis,
Using Wireshark to Solve Real-World Network Problems}
by Chris Sanders, 3rd Edition
April 2017, 368 pp.
ISBN-13:
978-1-59327-802-1

\link{https://nostarch.com/packetanalysis3} but also sometimes in \url{https://www.humblebundle.com/books}


\slide{Exercises and Prerequisites}

Exercise theme: Virtual Machines allows us play with things

\begin{list1}
\item This course includes exercises and getting the most of the course requires the participants to carry out these practical exercises
\item One VM based on Debian, running various tools\\
\url{https://codeberg.org/kramse/kramse-labs}
\item Network security and most internet related security work has the following requirements:
\begin{list2}
\item Network experience
\item TCP/IP principles - often in more detail than a common user
\item Programming is an advantage, for automating things
\item Some Linux and Unix knowledge is in my opinion a {\bf necessary skill} for infosec work\\
-- too many new tools to ignore, and lots found at sites like Github and Open Source written for Linux
\end{list2}
\end{list1}

\slide{Hackerlab Setup}

\hlkimage{7cm}{hacklab-1.png}

\begin{list2}
\item Hardware: modern laptop CPU with virtualisation\\
Dont forget to enable hardware virtualisation in the BIOS
\item Software Host OS: Windows, Mac, Linux
\item Virtualisation software: VMware, Virtual box, HyperV pick your poison
\item {\bf Hackersoftware: Kali Virtual Machine \link{https://www.kali.org/}}
\end{list2}


\slide{Demo: output from running a git clone}

\begin{alltt}\footnotesize
user@Projects:tt$ {\bf git clone https://codeberg.org/kramse/kramse-labs.git}
Cloning into 'kramse-labs'...
remote: Enumerating objects: 283, done.
remote: Total 283 (delta 0), reused 0 (delta 0), pack-reused 283
Receiving objects: 100% (283/283), 215.04 KiB | 898.00 KiB/s, done.
Resolving deltas: 100% (145/145), done.

user@Projects:tt$ {\bf cd kramse-labs/}

user@Projects:kramse-labs$ {\bf ls}
LICENSE  README.md  core-net-lab  lab-network  suricatazeek  work-station
user@Projects:kramse-labs$ git pull
Already up to date.
\end{alltt}

\begin{list2}
\item Skills like these will allow you to run 100s or 1000s of applications, tools etc.!
\item In the \emph{docker-install} directory are Ansible YAML files to install Docker on Debian easily!
\end{list2}

Look for \emph{awesome lists} on various subjects

\slide{Your Network}
.
\hlkrightpic{85mm}{-1cm}{sample-network.png}

\begin{list1}
\item I have a home network which has the following systems:
\begin{list2}
\item OpenBSD router
\item Juniper and small TP-Link switches
\item UniFi wireless access-point
\end{list2}
\end{list1}

Due to online remote teaching - we will investigate other networks and scan across the internet to \emph{my servers}!

\slide{Lab Networks}

\hlkimage{55mm}{opal-sft1200.jpg}

\begin{list2}
\item When learning and investigating it is nice to have a \emph{lab network} -- make changes, play with settings, break things
\item If you live alone, and are not in a remote meeting -- play with you own network!
\item I recommended the small GL-Inet Opal (GL-SFT1200) Wireless Travel Router\\
\url{https://store.gl-inet.com/products/opal-gigabit-wireless-pocket-sized-openwrt-ipv6-sft1200}
\item It has 2 LAN ports for connecting, 1 WAN port for Internet or can act as a Wi-Fi client. All powered by USB-C etc.
\item Manual and documentation \url{https://docs.gl-inet.com/router/en/4/user_guide/gl-sft1200/}
\end{list2}

\slide{Confidentiality Integrity Availability}

\hlkimage{8cm}{cia-triad-uk.pdf}

\begin{list1}
\item We want to protect something
\item Confidentiality - data kept secret
\item Integrity - data is not subject to unauthorized changes
\item Availability - data and system are available when needed
\end{list1}

\slide{Unencrypted data protocols }

Examples
\begin{list2}
\item TFTP use UDP and is unencrypted
\item TFTP still used for configuration files and firmwares
\item FTP sends data in cleartext\\
{\bfseries USER username}\\
{\bfseries PASS password}\\
Stop using FTP on the internet!
\item DNS sending unencrypted on UDP and TCP\\
Use DNS over HTTPS (DoH) or DNS over TLS (DoT)
\end{list2}



\slide{Person in the middle attacks}

\begin{list1}
\item ARP spoofing, ICMP redirects, the classics
\item Used to be called Man in The Middle (MiTM)
\begin{list2}
\item ICMP redirect
\item ARP spoofing
\item Wireless listening and spoofing higher levels like  airpwn-ng \link{https://github.com/ICSec/airpwn-ng}
\end{list2}
\item Usually aimed at unencrypted protocols or redirecting clients to wrong sites
\end{list1}


\slide{Recommended Reading}

So to get started in network security I recommend learning the basics:
\begin{list2}
\item Chapter 1: Packet Analysis and Network Basics
\item Chapter 2: Tapping into the Wire
\item Chapter 3: Introduction to Wireshark
\end{list2}
\emph{Practical Packet Analysis,
Using Wireshark to Solve Real-World Network Problems}
by Chris Sanders, 3rd Edition



\slide{TCP/IP Protocol Suite}

\hlkimage{13cm}{ipext-security-problems.png}
Skim if you like:

\begin{list2}
\item
\emph{Security problems in the TCP/IP protocol suite}, S. M. Bellovin April 1989,\\
 \url{https://www.cs.columbia.edu/~smb/papers/ipext.pdf}
\item \emph{A Look Back at “Security Problems in the TCP/IP Protocol Suite”} 2004,\\
 \url{https://www.cs.columbia.edu/~smb/papers/acsac-ipext.pdf}
\end{list2}



\slide{Still TCP/IP Problems?}

Recent example from 2020:
\begin{quote}
The JSOF research lab has discovered a series of zero-day vulnerabilities in a widely used low-level TCP/IP software library developed by Treck, Inc. The 19 vulnerabilities, given the name Ripple20, affect hundreds of millions of devices (or more) and include multiple remote code execution vulnerabilities.
\end{quote}

\begin{quote}
{\bf Pre-emptive traffic filtering is an effective technique that can be applied as appropriate to your network environment.}
\end{quote}
Source: \link{https://www.jsof-tech.com/ripple20/}

\begin{list2}
\item I highly recommend mature and known technologies like firewalls -- both network and hosts
\item Isolation into different VLANs and zones
\item Layer 2 attacks only work if you are in the same L2 zone!
\end{list2}


\slide{Cryptography}


\begin{list1}
\item Cryptography or cryptology is the practice and study of techniques for secure communication
\item Modern cryptography is heavily based on mathematical theory and computer science practice; cryptographic algorithms are designed around computational hardness assumptions, making such algorithms hard to break in practice by any adversary
\item Symmetric-key cryptography refers to encryption methods in which both the sender and receiver share the same key, to ensure confidentiality, example algorithm AES
\item Public-key cryptography (like RSA) uses two related keys, a key pair of a public key and a private key. This allows for easier key exchanges, and can provide confidentiality, and methods for signatures and other services
\end{list1}

Source: \link{https://en.wikipedia.org/wiki/Cryptography}


\slide{Serious Cryptography}

\hlkimage{5cm}{SeriousCrypto2e.jpg}


\emph{Serious Cryptography, 2nd Edition
A Practical Introduction to Modern Encryption}
by Jean-Philippe Aumasson
August 2024, 376 pp
ISBN-13:
9781718503847
\link{https://nostarch.com/serious-cryptography-2nd-edition}



\slide{SMTP TLS}

\begin{quote}
The STARTTLS command for IMAP and POP3 is defined in RFC 2595, for SMTP in RFC 3207, for XMPP in RFC 6120 and for NNTP in RFC 4642. For IRC, the IRCv3 Working Group
 has defined the STARTTLS extension. FTP uses the command "AUTH TLS" defined in RFC 4217 and LDAP defines a protocol extension OID in RFC 2830. HTTP uses upgrade header.
\end{quote}

\begin{list1}
\item SMTP was extended with support for Transport Layer Security TLS
\item Also called {\bf Opportunistic TLS}, where the quote is also from:\\ \link{https://en.wikipedia.org/wiki/Opportunistic_TLS}
\item Now we have MTA Strict Transport Security (MTA-STS) RFC 8461\\
so we can announce that we only accept encrypted email!
\item {\bf It is \the\year\ you should ALL turn off unencrypted SMTP} {\myalert}
\end{list1}


\slide{DNS over TLS vs DNS over HTTPS - DNS encryption}

\begin{list2}
\item Protocols exist that encrypt DNS data
\item Today we have competing standards:
\item
\emph{Specification for DNS over Transport Layer Security (TLS)} (DoT), RFC7858 MAY 2016\\
\link{https://en.wikipedia.org/wiki/DNS_over_TLS}

\item \emph{DNS Queries over HTTPS (DoH)} RFC8484

\item How to cofigure DoT\\ \link{https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Clients}
\end{list2}



\slide{Linux Wireguard VPN}

\begin{quote}\small
WireGuard is a secure network tunnel, operating at layer 3, implemented as a kernel virtual network interface for Linux, which aims to replace both IPsec for most use cases, as well as popular user space and/or TLS-based solutions like OpenVPN, while being more secure, more performant, and easier to use.
\end{quote}

Description from \link{https://www.wireguard.com/papers/wireguard.pdf}

\begin{list2}
\item Very easy to setup!
\item single round trip key exchange, based on NoiseIK
\item Short pre-shared static keys—Curve25519
\item strong perfect forward secrecy
\item Transport
speed is accomplished using ChaCha20Poly1305 authenticated-encryption
\item encapsulation of packets in UDP
\item WireGuard can be
simply implemented for Linux in less than 4,000 lines of code, making it easily audited and verified
\end{list2}



\slide{Security Vulnerabilities Have Dependencies}

\hlkimage{16cm}{cve-details-new-updated.png}
So you read about a new security vulnerability, it is bad!
\begin{list2}
\item New vulns all the time, every day, week, month -- year round
\end{list2}


\slide{CVE-2025-49704 SharePoint Remote Code Execution July 2025 }

\begin{quote}
{\bf\large Bornholms Regionskommune under hackerangreb} 22. juli 2025\\
Kommunens hjemmesider og intranet bliver lukket i fire timer, mens ny software bliver installeret for at stoppe angrebet.

Bornholms Regionskommune har været udsat for et omfattende hackerangreb.

Helt konkret er der tale om et angreb via en såkaldt zero day-sårbarhed i programmet {\bf SharePoint fra Microsoft}, som benyttes til kommunens hjemmesider og intranet.

En zero day-sårbarhed er et sikkerhedshul, som endnu ikke er blevet lukket af virksomheden bag softwaren – i dette tilfælde Microsoft – og som derfor kan udnyttes af hackere til at opnå adgang.

– Vi er virkelig under et stort pres, men Microsoft har reageret hurtigt og er kommet med en opdatering, der kan løse problemet, siger Claus Munk, leder af Digitalisering, IT og AI i Bornholms Regionskommune.
\end{quote}
Source: \url{https://www.dr.dk/nyheder/bornholms-regionskommune-under-hackerangreb}
\begin{list2}
\item Probably CVE-2025-49704 see \url{https://www.cvedetails.com/cve/CVE-2025-49704/} and CVE-2025-49706
\end{list2}


\slide{CVE-2025-49706 \& CVE-2025-49704 to get unauthorised RCE}

%\hlkimage{}{}

\begin{quote}
On the evening of July 18, 2025, Eye Security was the first in identifying large-scale exploitation of a SharePoint remote code execution (RCE) vulnerability chain in the wild. Demonstrated just days before on X, this exploit is being used to compromise on-premise SharePoint Servers across the world. The chain we uncover in this blog combines CVE-2025-49706 \& CVE-2025-49704 to get unauthorised RCE on unpatched SharePoint Servers.

After we learned about this chain being exploited in the wild, our team scanned over 23000 SharePoint servers worldwide. In total, we discovered more then 400 systems actively compromised during four confirmed waves of attack:

\begin{list2}
\item     confirmed initial wave on 17th of July at 12:51 UTC from 96.9.125[.]147 (probably testing)
\item     confirmed wave \#1 on 18th of July at 18:06 UTC from 107.191.58[.]76 (widely successful)
\item     confirmed wave \#2 on 19th of July at 07:28 UTC from 104.238.159[.]149
\item     confirmed multiple waves on and after 21th of July
\end{list2}

\end{quote}
Source: \url{https://research.eye.security/sharepoint-under-siege/}


\slide{Exploit Public-Facing Application}

\begin{quote}
Adversaries may attempt to exploit a weakness in an Internet-facing host or system to initially access a network. The weakness in the system can be a software bug, a temporary glitch, or a misconfiguration.

Exploited applications are often websites/web servers, but can also include databases (like SQL), standard services (like SMB or SSH), network device administration and management protocols (like SNMP and Smart Install), and any other system with Internet-accessible open sockets.[1][2][3][4][5] On ESXi infrastructure, adversaries may exploit exposed OpenSLP services; they may alternatively exploit exposed VMware vCenter servers.[6][7] Depending on the flaw being exploited, this may also involve Exploitation for Defense Evasion or Exploitation for Client Execution.
\end{quote}
Source: \url{https://attack.mitre.org/techniques/T1190/}


\begin{list2}
    \item Part of the Mitre ATT\&CK Framework \url{https://attack.mitre.org/}
\end{list2}


\slide{Weak password allowed hackers to sink a 158-year-old company}

%\hlkimage{}{}

\begin{quote}
One password is believed to have been all it took for a ransomware gang to destroy a 158-year-old company and put 700 people out of work.

KNP - a Northamptonshire transport company - is just one of tens of thousands of UK businesses that have been hit by such attacks.

Big names such as M\&S, Co-op and Harrods have all been attacked in recent months. The chief executive of Co-op confirmed last week that all 6.5 million of its members had had their data stolen.

In KNP's case, it's thought the hackers managed to gain entry to the computer system by guessing an employee's password, after which they encrypted the company's data and locked its internal systems.

KNP director Paul Abbott says he hasn't told the employee that their compromised password most likely led to the destruction of the company.
\end{quote}
Source: \url{https://www.bbc.com/news/articles/cx2gx28815wo} July 2025


\slide{How to react to zero-days in zero-time?!}

There will be vulnerabilities in the products you use -- especially over a time frame of years!

So maybe, just maybe:
\begin{list2}
\item Lock down administration\\
Do NOT put your administrative interfaces directly on the Internet\\
We can see ESXi web administration, router administration -- on the internet
\item Update your systems\\
We see hacker exploiting known vulnerabilities much more than using \emph{super advanced hitech state of the art exploits}
\item Change default passwords
\item Monitor your systems
\end{list2}

Essentially this boils down to design, architecture and defense in depth

\slide{Design and Architecture}

%\hlkimage{3cm}{exercise.png}
\hlkimage{5cm}{johnny_automatic_blueprints.png}

\begin{list2}
\item Which systems need to communicate, which departments
\item How strict are you allowed to make things
\item Default allow -- permissive, or default block -- restrictive
\item and what are the constraints, budgets, resources, time, money, ...
\item I recommend using tools like Decision Records for making sure alternatives are considered etc.\\
\url{https://github.com/joelparkerhenderson/decision-record/blob/main/template/template.md}
\end{list2}




\slide{Protection, building secure and robust networks}

\hlkimage{14cm}{sample-ip-network.pdf}


\begin{list2}
\item We should prefer security mechanisms that does NOT require us to keep patching every month
\item Can we change our networks to avoid this? Yes!
\end{list2}



\slide{Address planning -- helps security for both IPv4 and IPv6! }

%\hlkimage{}{}

\begin{quote}
IPv6 address allocations and overall architecture are important parts
of securing IPv6.  Initial designs, even if intended to be temporary,
tend to last much longer than expected.  Although IPv6 was initially
thought to make renumbering easy, in practice, it may be extremely
difficult to renumber without a proper IP Address Management (IPAM)
system.  [RFC7010] introduces the mechanisms that could be utilized
for IPv6 site renumbering and tries to cover most of the explicit
issues and requirements associated with IPv6 renumbering.

{\bf A key task for a successful IPv6 deployment is to prepare an
addressing plan.  Because an abundance of address space is available,
structuring an address plan around both services and geographic
locations allows address space to become a basis for more structured
security policies to permit or deny services between geographic
regions}.  [RFC6177] documents some operational considerations of
using different prefix sizes for address assignments at end sites.
\end{quote}
Source: RFC 9099

\begin{list2}
\item You have space, use it!
\end{list2}


\slide{Network Architecture and Address planning }

\hlkimage{8cm}{ipv6-linked-to-ipv4.png}
Source: picture from Surfnet Preparing and IPv6 Address Plan

\begin{list2}
\item Take the opportunity to re-design your network! Create a design, consider it green field, work towards it!
\item Use /127 for point-to-point links, add loopback addresses on routers, allows filtering of access to management
\item You can also make parts IPv6-only, Veronika McKillop at TROOPERS19 \emph{Microsoft IT (secure) journey to IPv6-only}\\
\link{https://troopers.de/troopers19/agenda/h7sv7v/}
\end{list2}



\slide{Modern Firewall Infrastructures}


\centerline{\hlkbig A firewall {\color{security6blue}blocks traffic} on a network}

\vskip 1 cm
\pause

\centerline{\hlkbig A firewall {\color{red}allows traffic} on a network}
{\small The interesting part is typically what it allows!}

\begin{list1}
\item A firewall infrastructure must:
\begin{list2}
\item Prevent attackers from entering
\item Prevent data exfiltration
\item Prevent worms, malware, virus from spreading in networks
\item Be part of an overall solution with ISP, routers, other firewalls, switched infrastructures,\\
  intrusion detection systems and the rest of the infrastructure
\end{list2}
\end{list1}

\vskip 5mm
\centerline{Difficult -- and requires design and secure operations}



\slide{Packet Filtering}

\begin{alltt}\footnotesize
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\end{alltt}

\begin{list1}
\item Packet filtering are firewall devices filtering on single packet
\item Most \emph{specialized firewall devices} do stateful filtering and more
\item Don't forget IPv6 -- even though you haven't turned it on, it is there
\end{list1}




\slide{Modern Firewalls}

\begin{list1}
\item Basically some filtering between networks or network segments
\item Typically they contain:
  \begin{list2}
   \item Some interface, maybe web interface, often command line interface
\item TCP/IP filtering options -- packets flowing in and out, direction, protocol, ports etc.
\item Should be able to handle both IPv6 and legacy IPv4
\item Often they have predefined rules for common use-cases\\
Is this really a good thing if you can easily configure a bad protocol like Server Message Block to and from the Internet?
\item Most legacy setups use Network Address Translation (NAT) -- NAT is a kludge and bad!
\item Most platforms have extra network related features DHCP servers, DNS caching servers etc.
\end{list2}
\item The firewall devices are mostly allowing some {\bf stateful filtering} which are much easier to configure than a pure network packet filter
\end{list1}

Goal is to implement rules -- a security policy for isolation and data flow


\slide{Sample Rules from OpenBSD PF}

%\begin{figure}[H]\tiny
%\inputminted[linenos=true]{shell}{policies/gateway-config-simple.conf}
%\end{figure}
\begin{figure}[H]\tiny
\inputminted{shell}{policies/gateway-config-simple.conf}
\end{figure}

Note: the line with \verb+block all+ -- default deny

\slide{Example Firewall Products}
\begin{list2}
\item Checkpoint Firewall-1 \link{http://www.checkpoint.com}
\item Cisco ASA \link{http://www.cisco.com}
\item Juniper SRX \link{http://www.juniper.net}
\item Palo Alto \link{https://www.paloaltonetworks.com/}
\item Fortinet \link{https://www.fortinet.com/}
\end{list2}

Those listed are the most popular commercial ones I see in Denmark


\slide{OPNsense GUI based and easy to install}

\hlkimage{8cm}{images/screenshots_OPNsense-1024x518.png}

\begin{list1}
\item OPNsense \link{https://opnsense.org/}
\item Firewall built on FreeBSD with web interface
\item Originally thoughts from m0n0wall and later \link{https://www.pfsense.org/}\\
\item Danish companies have been using these for many years now
\end{list1}


\slide{Uncomplicated Firewall (UFW)}

\begin{alltt}\footnotesize
root@debian01:~# apt install ufw
...
root@debian01:~# ufw allow 22/tcp
Rules updated
Rules updated (v6)
root@debian01:~# ufw enable
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
Firewall is active and enabled on system startup
root@debian01:~# ufw status numbered
Status: active

     To                         Action      From
     --                         ------      ----
[ 1] 22/tcp                     ALLOW IN    Anywhere
[ 2] 22/tcp (v6)                ALLOW IN    Anywhere (v6)
\end{alltt}

\begin{list2}
\item Extremely easy to use -- I recommend and use the (Uncomplicated Firewall) UFW
\item All systems, Microsoft Windows, Unix etc. should have firewall enabled by now!
\end{list2}

\slide{Specialized Firewall devices are NOT Alone}

\hlkimage{15cm}{network-layers-1.png}

\centerline{Use Defense in Depth -- all layers have features}

\slide{Defense in depth}

%\hlkimage{10cm}{Bartizan.png}
\hlkimage{15cm}{medieval-clipart-5}
\centerline{Picture originally from: \url{http://karenswhimsy.com/public-domain-images}}




\slide{Address Resolution Protocol (ARP)}
\hlkimage{14cm}{arp-basic.pdf}

Systems that can communicate allow attackers access

Hacking is not magical -- if malware cannot \emph{connect home} it cannot be controlled

\slide{Wireshark - graphical packet dump and analysis}

\hlkimage{17cm}{images/wireshark-website.png}

\centerline{\link{http://www.wireshark.org}}
\centerline{Available for Windows and UNIX}

\slide{Using Wireshark}

\hlkimage{13cm}{images/wireshark-http.png}

\centerline{Capture - Options}

\slide{What about encrypted traffic}

\hlkimage{10cm}{images/wireshark-sni-twitter.png}

\centerline{Current TLS version 1.2 used in HTTPS show the name!}


\slide{UDP User Datagram Protocol}
\hlkimage{14cm}{udp-1.pdf}
\begin{list1}
\item RFC-768, \emph{connection-less}
\item Source IP in UDP attacks may be \emph{spoofed}
\end{list1}

\slide{TCP Transmission Control Protocol}
\hlkimage{14cm}{tcp-1.pdf}

\begin{list1}
\item RFC-791 September 1981, \emph{connection-oriented}
\end{list1}

\slide{TCP three way handshake}

\hlkimage{6cm}{images/tcp-three-way.pdf}

\begin{list2}
\item PPA chapter 8: Transport Layer Protocols
\item {\bfseries TCP SYN half-open} scans
\item If the three way handshake is established -- the source IP can be trusted in logs
\end{list2}

%\exercise{ex:wireshark-install}

\slide{Basic port scanning}

\begin{list1}
\item What is a port scan
\item Testing all values possible for port number from 0/1 to 65535
\item Goal is to identify open ports, listening and vulnerable services
\item Most often TCP og UDP scan
\item TCP scanning is more realiable than UDP scanning
\item TCP handshake must respond with SYN-ACK packets
\item UDP applications respond differently -- if they even respond\\
so probes with real requests may get response, no firewall they respond with ICMP on closed ports
\end{list1}



\slide{Scope: select systems for testing}

\hlkimage{10cm}{overview-routing-customer-2015.png}

\begin{list2}
\item Routers in front of critical systems and networks - availability
\item Firewalls -- are traffic flows restricted
\item Mail servers -- open for relaying
\item Web servers -- remote code execution in web systems, data download
\end{list2}

\slide{Well-Known Port Numbers}

\hlkimage{6cm}{iana1.jpg}

\begin{list1}
\item IANA maintains a list of magical numbers in TCP/IP
\item Lists of protocl numbers, port numers etc.
\item A few notable examples:
\begin{list2}
\item Port 25/tcp Simple Mail Transfer Protocol (SMTP)
\item Port 53/udp and 53/tcp Domain Name System (DNS)
\item Port 80/tcp Hyper Text Transfer Protocol (HTTP)
\item Port 443/tcp HTTP over TLS/SSL (HTTPS)
\end{list2}
\item Source: \link{http://www.iana.org}
\end{list1}

\slide{Ping and port sweep}

\begin{list1}
\item Scans across the network are named sweeps
\item Ping sweeps using ICMP Ping probes
\item Port sweep trying to find a specific service, like port 80 web
\item Quite easy to see in network traffic:
\begin{list2}
\item Selecting two IP-adresser not in use
\item Should not see any traffic, but if it does, its being scanned
\item If traffic is received on both addresses, its a sweep -- if they are a bit apart it is even better, like 10.0.0.100 and 10.0.0.200
  \end{list2}

\vskip 2cm
Pro tip: a Great network intrusion detection engine (IDS), is Suricata \link{suricata-ids.org}
\end{list1}

\slide{what is Nmap today}
\begin{quote}
Nmap ("Network Mapper") is a free and open source (license) utility for network discovery and security auditing.
\end{quote}

\begin{list1}
\item Initial release September 1997;
\item Today a package of programs for Windows, Mac, BSD, Linux, ... source
\item Flexible, powerful, and free! Includes other tools!
\item Lets check release notes: \url{http://seclists.org/nmap-announce/}
\end{list1}

Bonus info: you can help Nmap by submitting fingerprints


\slide{Nmap port sweep for web servers}

\begin{alltt}\small
root@cornerstone:~#{\bfseries  nmap -p80,443 172.29.0.0/24}

Starting Nmap 6.47 ( http://nmap.org ) at 2015-02-05 07:31 CET
Nmap scan report for 172.29.0.1
Host is up (0.00016s latency).
PORT    STATE    SERVICE
{\color{darkgreen}80/tcp  open     http}
443/tcp filtered https
MAC Address: 00:50:56:C0:00:08 (VMware)

Nmap scan report for 172.29.0.138
Host is up (0.00012s latency).
PORT    STATE  SERVICE
{\color{darkgreen}80/tcp  open   http}
443/tcp closed https
MAC Address: 00:0C:29:46:22:FB (VMware)

\end{alltt}

\slide{Nmap port sweep for SNMP port 161/UDP}

\begin{alltt}\small
root@cornerstone:~#{\bfseries nmap -sU -p 161 172.29.0.0/24}
Starting Nmap 6.47 ( http://nmap.org ) at 2015-02-05 07:30 CET
Nmap scan report for 172.29.0.1
Host is up (0.00015s latency).
PORT    STATE         SERVICE
{\color{darkgreen}161/udp open|filtered snmp}
MAC Address: 00:50:56:C0:00:08 (VMware)

Nmap scan report for 172.29.0.138
Host is up (0.00011s latency).
PORT    STATE  SERVICE
{\bf{161/udp closed snmp}}
MAC Address: 00:0C:29:46:22:FB (VMware)
...
Nmap done: 256 IP addresses (5 hosts up) scanned in 2.18 seconds
\end{alltt}

\vskip 5mm
\centerline{More reliable to use Nmap script with probes like --script=snmp-info}

\slide{Nmap Advanced OS detection}
\begin{alltt}\footnotesize
root@cornerstone:~#{\bfseries nmap -A -p80,443 172.29.0.0/24}
Starting Nmap 6.47 ( http://nmap.org ) at 2015-02-05 07:37 CET
Nmap scan report for 172.29.0.1
Host is up (0.00027s latency).
PORT    STATE    SERVICE VERSION
80/tcp  open     http    Apache httpd 2.2.26 ((Unix) DAV/2 mod_ssl/2.2.26 OpenSSL/0.9.8zc)
|_http-title: Site doesn't have a title (text/html).
443/tcp filtered https
MAC Address: 00:50:56:C0:00:08 (VMware)
Device type: media device|general purpose|phone
Running: Apple iOS 6.X|4.X|5.X, Apple Mac OS X 10.7.X|10.9.X|10.8.X
OS details: Apple iOS 6.1.3, Apple Mac OS X 10.7.0 (Lion) - 10.9.2 (Mavericks)
or iOS 4.1 - 7.1 (Darwin 10.0.0 - 14.0.0), Apple Mac OS X 10.8 - 10.8.3 (Mountain Lion)
or iOS 5.1.1 - 6.1.5 (Darwin 12.0.0 - 13.0.0)
OS and Service detection performed.
Please report any incorrect results at http://nmap.org/submit/
\end{alltt}

\begin{list2}
\item Low-level way to identify operating systems, also try/use
  \verb+nmap -A+
\item Send probes and observe responses, lookup in table of known OS and responses
\item Techniques known since at least: \emph{ICMP Usage In Scanning} Version 3.0,
  Ofir Arkin, 2001 %\link{https://web.archive.org/web/20050210093427/http://www.sys-security.com/html/projects/icmp.html} % Original side er død
\end{list2}


\slide{DDoS protection and flooding}

\hlkimage{12cm}{overview-routing-customer-2015.pdf}

\begin{list2}
\item Transport Layer Attacks TCP SYN flood TCP sequence numbers
\item High level attacks like Slowloris - keep TCP/HTTP connection for a long time.
\end{list2}


\slide{Availability and Network flooding attacks}

\begin{list2}
\item SYN flood is the most basic and very common on the internet towards 80/tcp and 443/tcp
\item ICMP and UDP flooding are the next targets
\item Supporting litterature is TCP Synfloods - an old yet current problem, and improving pf's response to it, Henning Brauer, BSDCan 2017
\item All of them try to use up some resources
\begin{list2}
\item Memory space in specific sections of the kernel, TCP state, firewalls state, number of concurrent sessions/connections
\item interrupt processing of packets - packets per second
\item CPU processing in firewalls, pps
\item CPU processing in server software
\item Bandwidth - megabits per second mbps
\end{list2}
\end{list2}

There are multiple resources about DDoS protection with more low level technical measures to implement at\\
{\footnotesize \link{https://codeberg.org/kramse/security-courses/tree/master/presentations/network/introduction-ddos-testing}}


\slide{Stress testing and DDoS}

\hlkimage{13cm}{penguinping-02-peak.png}

\begin{list2}
\item PenguinPing packet generator, my high speed packet generator
home page: \link{https://penguinping.org}
\item First versions are only about 230 lines of Lua code and implement basic command line to replace hping3
\item Built on top of MoonGen/libmoon \link{https://github.com/emmericp/MoonGen}
\end{list2}

\centerline{Extremely fast and allows easy customization}


\slide{Process: monitor, attack, break, repeat}

\begin{list2}
\item Pre-test: Monitoring setup - from multiple points
\item Pre-test: Perform full Nmap scan of network and ports
\item Start small, run with delays between packets
\item Turn up until it breaks, decrease delay - until using \verb+--flood+
\item Monitor speed of attack on your router interface pps/bandwidth
\item Give it maximum speed\\
 \verb+hping3 --flood -1+ and \verb+hping3 --flood -2+
\item Have a common chat with network operators/customer to talk about symptoms and things observed
\item Any information resulting from testing is good information
\end{list2}

\vskip 1cm
\centerline{Ohh we lost our VPN into the environment, ohh the fw console is dead}


\slide{Best Current Practice }

%\hlkimage{}{}

\begin{quote}
Lets get this documented, you should already be doing
\end{quote}

\begin{list2}
\item Network segmentation and filtering -- we could write a book about this! {\myalert}
\item Monitor your network -- both bandwidth, error, netflow etc. {\myalert}
\item Take control of your network, no more admin/admin logins on core devices {\myalert}
\item Turn on authentication for protocols -- routing protocols but also any http service within your org {\myalert}
\item Configure host-based firewalls {\myalert}
\item Control DNS -- internally and externally, recursive, authoritative etc. {\myalert}
\end{list2}

\centerline{This goes for IPv4-only, IPv6-only, and mixed networks!}


\slide{Together with Firewalls - Virtual LAN (VLAN)}

\hlkimage{8cm}{vlan-portbased.pdf}

\begin{list1}
\item Managed switches often allow splitting into zones called virtual LANs
\item Most simple version is port based
\item Like putting ports 1-4 into one LAN and remaining in another LAN
\item Packets must traverse a router or firewall to cross between VLANs
\end{list1}

\slide{Virtual LAN (VLAN) IEEE 802.1q}

\hlkimage{15cm}{vlan-8021q.pdf}

\begin{list1}
\item Using IEEE 802.1q  VLAN tagging on Ethernet frames
\item Virtual LAN, to pass from one to another, must use a router/firewall
\item Allows separation/segmentation and protects traffic from many security issues
\item Used in most, if not all, Wi-Fi networks -- each SSID has a VLAN behind it
\end{list1}




\slide{Network Access Control -- Connecting clients more securely}

Talking about standard, another useful one:\\
IEEE 802.1x -- Port Based Network Access Control

\hlkimage{7cm}{802.1X_wired_protocols.png}

\begin{list1}
\item Authentication protocol ensures user validation before port access
\item Can authenticate using username and then password or certificate
\item Typically RADIUS and 802.1x which can use LDAP or Active Directory
\item Already used in Wi-Fi networks, so can be turned on for wired Ethernet ports
\end{list1}


\slide{Creating an Access Control List (ACL)}

%\hlkimage{}{}

\begin{alltt}\small
 (config)#ipv6 access-list RA-GUARD
 (config-ipv6-acl)#sequence 3 deny icmp any any router-advertisement
 (config-ipv6-acl)#sequence 6 permit ipv6 any any
 (config-ipv6-acl)#exit
 (config)#interface FastEthernet0/5
 (config-if)#ipv6 traffic-filter RA-GUARD in
\end{alltt}
Source: example copied from RIPE NCC IPv6 Security Training materials:\\
\link{https://www.ripe.net/support/training/material/ipv6-security/ipv6security-slides.pdf}

\begin{list2}
\item Best practice, and not that hard to do -- Layer 2 protection
\item ACL, filtering and firewalling will create longer lasting protection
\item Paired with a nice address plan you can easily put restrictions on traffic flow, without hurting functionality or the business
\item Does ANY client in ANY office NEEEEEED to connect to ANY UPS, Virtualisation and printer across the world ...
\end{list2}




\slide{Example high level blueprint and process}

%\hlkimage{}{}

\begin{list2}
\item Create an address plan that matches the organisation, physical restrictions, cloud, on-premise etc.
\item Create security policies from a high level, top-level mission, Information security management system (ISMS) if you have resources
\item Map out the current network
\item Implement changes that you can now
\item Make procedures and requirements for new systems
\item Start migration or phasing out older systems that do not follow guidelines and requirements
\end{list2}

and for forensics purposes start logging!


Note: I recommend logging in controlled networks, I do NOT condone mass sureveillance!

\slide{Lock down management}

\hlkimage{14cm}{generic-network-pressure-points.pdf}

Routers often have a control plane and a data plane. The first is controlling the device, and provides
management, while the data plane is forwarding and routing the packets. The data plane is mostly hardware based on high-end devices, and can forward at full wire speed.


\slide{Defense in depth}

%\hlkimage{10cm}{Bartizan.png}
\hlkimage{15cm}{medieval-clipart-5}
\centerline{Picture originally from: \url{http://karenswhimsy.com/public-domain-images}}

\slide{Defense in depth - layered security}

\hlkimage{6cm}{security-layers-1-uk.pdf}

\centerline{\hlkbig\color{security6blue} Multiple layers of security! Isolation!}

\slide{Control-Plane Access Control Lists (CP-ACL)}

Management of network devices can be done with Access Control lists, other systems may be put into a management VLAN

An example from a Cisco router using secure shell is shown below with a simple standard Access Control List (ACL) named 22 and then referenced for the virtual terminal (vty) secure shell (ssh):

\begin{alltt}\scriptsize
ip access-list standard 22
10 permit 192.0.2.2
20 permit 172.13.22.10
30 permit 192.168.0.10
40 permit 203.0.113.10
line vty 0 4
  access-class 22 in
  transport input ssh
\end{alltt}

This will reduce the likelihood that an attacker can gain access to the administration using leaked username and passwords or because of vulnerabilities in the software.

\slide{Network Segmentation: Which VLANs to create}

Using VLANs to segment networks we can extend it to the rest of the network, and an example of isolated segments could be:
\begin{list2}
\item Guest network for cabled and Wi-Fi clients
\item Client networks can be isolated per department, floor or building
\item Server networks for multiple purposes – development, staging, testing, production, manufacturing, …
\item Internet servers in a demilitarized zone (DMZ)4 which would make it less likely that compromised internet
server would affect the rest of the network
\item Dedicated printer network
\item Management network for virtualisation, one for network management, one for storage
\end{list2}



\slide{Block outgoing traffic too}

\begin{list1}
\item Some services should \emph{not} cross firewalls, at least not to the internet
\item Some services are too \emph{fragile}

\begin{list2}
\item Windows SMB file sharing is \emph{only} for small internal networks
\item Unix NFS is like-wise \emph{only} for internal use
\item Outgoing email should only go via dedicated relays
\item LDAP outgoing, why?! See the log4j CVE-2021-44228
\item Create a list, document them and consider them dead!
\end{list2}
\item Making a positive list of allowed protocols would be best, but may require too many resources to implement and update
\end{list1}


\slide{Proxy servers and Web Application Firewalls (WAF)}

\begin{list2}
\item Filtrering at higher layers is also possible
\item Web proxies for clients can help security a lot -- a centralized filter for everyone

\item Reverse proxies for web applications are called
Web Application Firewalls (WAF) -- and filter incoming web requests, and outgoing answers. Can help with attacks like SQL injection and exfiltration of data
\item Depending on your network it can replace or be combined with filtering on DNS servers, and I would prefer to filter domains with DNS
\item I would also prefer blocking large prefixes of IP destinations using routers/stateless packet filters -- maybe use BGP for distributing \emph{lists}
\end{list2}


\slide{Cloud Network Security: Cilium overview}

\hlkimage{12cm}{cilium-overview.png}

\begin{quote}
Kubernetes provides Network Policies for controlling traffic going in and out of the pods. Cilium implements the Kubernetes Network Policies for L3/L4 level and extends with L7 policies for granular API-level security for common protocols such as HTTP, Kafka, gRPC, etc
\end{quote}
Source: picture and text from \link{https://cilium.io/blog/2018/09/19/kubernetes-network-policies/}




\slide{Logging and Monitoring}

%\hlkimage{}{}


\begin{list2}
\item This part is only a quick overview -- next modules will dive deeper!
\end{list2}


\slide{Netflow and Session Logging}

\begin{list2}
\item Netflow is getting more important, more data share the same links
\item Accounting is important
\item Detecting DoS/DDoS and problems is essential
\item Netflow sampling is vital information - 123Mbit, but what kind of traffic
\item NFSen is an old but free application
\link{http://nfsen.sourceforge.net/}
\item Currently also investigating sFlow - hopefully more fine grained
\item sFlow, short for "sampled flow", is an industry standard for packet export at Layer 2 of the OSI model, \\
\link{https://en.wikipedia.org/wiki/SFlow}
\end{list2}




\slide{Netflow using NFSen}

\hlkimage{13cm}{images/nfsen-overview.png}


\slide{ Netflow NFSen}

\hlkimage{17cm}{nfsen-udp-flood.png}

\centerline{An extra 100k packets per second from this netflow source (source is a router)}



\slide{ElastiFlow -- Elasticsearch based}

\hlkimage{10cm}{elastiflow.png}

\begin{quote}
  ElastiFlow™ provides network flow data collection and visualization using the Elastic Stack (Elasticsearch, Logstash and Kibana). It supports Netflow v5/v9, sFlow and IPFIX flow types (1.x versions support only Netflow v5/v9).
\end{quote}
Source: Picture and text from \link{https://github.com/robcowart/elastiflow} \\

\slide{Akvorado: flow collector, enricher and visualizer}

\hlkimage{8cm}{akvorado-timeseries.png}

\begin{quote}
This program receives flows (currently Netflow/IPFIX and sFlow), enriches them with interface names (using SNMP), geo information (using IPinfo.io), and exports them to Kafka, then ClickHouse. It also exposes a web interface to browse the collected data.
\end{quote}
Source: Picture and text from \url{https://github.com/akvorado/akvorado}


\slide{Big Data tools: Elasticsearch and Kibana}

\hlkimage{10cm}{kibana-basics-with-vega.jpg}

Elasticsearch is an open source distributed, RESTful search and analytics engine capable of solving a growing number of use cases.

\link{https://www.elastic.co}

\slide{DNS logging}

Since most malware uses DNS today, to be able to switch to new command and control endpoints, we can leverage that to our advantage.

Domain Name System (DNS) depends on a query from the client, and a server that resolves this to a value.

\begin{list2}
\item We can log any DNS traffic into a database
\item We can look up if any clients have done a lookup for a specific name or IP during incident handling
\item This can confirm if a client has ever \emph{visited} a malicious site, because first it needs to lookup the name to IP address before it can make the TCP/HTTP connection, or send data
\end{list2}



\slide{Unbound and NSD}

\begin{quote}
Unbound is a validating, recursive, caching DNS resolver. It is designed to be fast and lean and incorporates modern features based on open standards.

To help increase online privacy, Unbound supports DNS-over-TLS which allows clients to encrypt their communication. In addition, it supports various modern standards that limit the amount of data exchanged with authoritative servers.
\end{quote}

\link{https://www.nlnetlabs.nl/projects/unbound/about/}

My preferred local DNS server.

Also check out uncensored DNS and his DNS over TLS setup!\\
Even has pinning information available:\\ {\small\link{https://blog.censurfridns.dk/blog/32-dns-over-tls-pinning-information-for-unicastcensurfridnsdk/}}



\slide{Building Secure Infrastructures}

\begin{list1}
\item A real-life setup of an infrastructure from scratch can be daunting!
\item You need:
\begin{list2}
\item Policies
\item Procedures
\item Incident Response
\end{list2}
\item Running systems which require
\begin{list2}
\item Configurations
\item Settings
\item Supporting infrastructure -- networks
\item Supporting infrastructure -- logging, dash boarding, monitoring
\end{list2}
\item Building something \emph{secure} is {\bf hard work!}
\end{list1}




\slide{Concrete advice for enterprise networks}


\begin{list2}
\item Portscanning - start using portscans in your networks, verify how far malware and hackers can travel, and identify soft systems needing updates or isolation
\item Have separation -- anywhere, starting with organisation units, management networks, server networks, customers, guests, LAN, WAN, Mail, web, ...
\item Use Web proxies - do not allow HTTP directly except for a short allow list, \\
do not allow traffic to and from any new TLD
\item Use only your own DNS servers, create a pair of Unbound servers, \\
point your internal DNS running on Windows to these\\
Create filtering, logging, restrictions on these Unbound DNS servers\\
\link{https://www.nlnetlabs.nl/projects/unbound/about/} and also \link{https://pi-hole.net/}
\item Only allow SMTP via your own mail servers, create a simple forwarder if you must
\end{list2}

Allow lists are better than block list, even if it takes some time to do it


\slide{DROP SOME TRAFFIC NOW}

\begin{list2}
\item Drop some traffic on the border of everything
\item Seriously do NOT allow Windows RPC across borders
\item Border here may be from regional country office back to HQ
\item Border may be from internet to internal networks
\item Block Windows RPC ports, 135, 137, 139, 445
\item Block DNS directly to internet, do not allow clients to use any DNS, fake 8.8.8.8 if you must internally
\item Block SMTP directly to internet
\item Create allow list for internal networks, client networks should not contact other client networks but only relevant server networks
\end{list2}

You DONT need to allow direct DNS towards internet, except from your own recursive DNS servers

If you get hacked by Windows RPC in 2022, you probably deserve it, sorry for being blunt

Best would be to analyze traffic and create allow lists, some internal networks to not need internet at all


\slide{Default permit}

%\hlkimage{}{}

One of the early implementers of firewalls Marcus J. Ranum summarized in 2005 The Six Dumbest Ideas in Computer Security \link{https://www.ranum.com/security/computer_security/editorials/dumb/} which includes the always appropriate discussion about default permit versus default deny.

\begin{quote}\small {\bf
\#1) Default Permit}\\
This dumb idea crops up in a lot of different forms; it’s incredibly persistent and difficult to eradicate. Why? Because it’s so attractive. Systems based on ”Default Permit” are the computer security equivalent of empty calories: tasty, yet fattening.

The most recognizable form in which the ”Default Permit” dumb idea manifests itself is in firewall rules. Back in the very early days of computer security, network managers would set up an internet connection and decide to secure it by turning off incoming telnet, incoming rlogin, and incoming FTP. Everything else was allowed through, hence the name ”Default Permit.” This put the security practitioner in an endless arms-race with the hackers.
\end{quote}


\begin{list2}
\item Allow all current networks today on all ports for all protocols \emph{is} an allow list \\
Which tomorrow can be split into one for TCP, UDP and remaining, and measured upon
\item Measure, improve, repeat
\end{list2}



\slide{We cannot do X}

\begin{quote}
We cannot block SMTP from internal networks, since we do not know for sure if vendor X equipment needs to send the MOST important email alert at some unspecific time in the future
\end{quote}

Cool, then we can do an allow list starting today on our border firewall:
\begin{alltt}
table <smtp-exchange> \{ $exchange1 $exchange2 $exchange3 \}
table <smtp-unknown> persist file "/firewall/mail/smtp-internal-unknown.txt"
# Regular use, allowed
pass out on egress inet proto tcp from smtp-exchange to any port 25/tcp
# Unknown, remove when phased out
pass out on egress inet proto tcp from smtp-unknown to any port 25/tcp
\end{alltt}

Year 0 the unknown list may be 100\% of all internal networks, but new networks added to infrastructure are NOT added, so list will shrink -- evaluate the list, and compare to network logs, did networks send ANY SMTP for 1,2,3 years?


\slide{Conclusion}

% \hlkrightimage{15cm}{network-layers-1.png}

\begin{list2}
\item Implement firewalls -- take control over network packets
\item Read the Fine manuals -- your devices already has a lot to offer
\item Make a policy for networks, make incremental changes, configure security for new parts and VLANs in the network\\
Over time the older ones will be phased out, replaced or can have the same configuration applied with little trouble
\item Start from the bottom and from client ports, or from server ports if you like
\item Learn some Linux and use open source projects, really, will save you thosands of USD/EUR/DKK
\end{list2}




\end{document}
